'use client'

/**
 * Step 3: Store on Blockchain
 *
 * Handles the multi-stage storage process:
 * 1. Upload file to IPFS (with progress and retry)
 * 2. Send blockchain transaction (automatic, no popup)
 * 3. Wait for confirmations
 * 4. Display success with links
 */

import { useState, useEffect } from 'react'
import {
  Cloud,
  Shield,
  CheckCircle,
  AlertCircle,
  Loader2,
  ExternalLink,
  RefreshCw,
  FileText,
  History,
} from 'lucide-react'
import { FileData, SignatureData, BlockchainData, IPFSProgress, BlockchainProgress } from '../../types/stepper'
import { useContract } from '../../hooks/useContract'
import { useNetwork } from '../../contexts/NetworkContext'
import { uploadToIPFS, getIPFSGatewayURL, getIPFSErrorMessage } from '../../utils/ipfs'
import { UPLOAD_CONFIG } from '../../config/upload'
import { HashUtils } from '../../utils/hash'
import { AddressDisplay } from '../AddressDisplay'
import { ethers } from 'ethers'

interface Step3StoreBlockchainProps {
  /** File data from Step 1 */
  fileData: FileData
  /** Signature data from Step 2 */
  signatureData: SignatureData
  /** Blockchain data if already stored */
  blockchainData: BlockchainData | null
  /** Callback when successfully stored */
  onStored: (data: BlockchainData) => void
  /** Start another document */
  onSignAnother: () => void
  /** View in history */
  onViewHistory: () => void
}

export function Step3StoreBlockchain({
  fileData,
  signatureData,
  blockchainData,
  onStored,
  onSignAnother,
  onViewHistory,
}: Step3StoreBlockchainProps) {
  const { storeDocumentHash } = useContract()
  const { networkConfig } = useNetwork()

  const [ipfsProgress, setIpfsProgress] = useState<IPFSProgress>({
    status: 'idle',
    progress: 0,
  })

  const [blockchainProgress, setBlockchainProgress] = useState<BlockchainProgress>({
    status: 'idle',
  })

  const [error, setError] = useState<string | null>(null)

  // Auto-start storage process if not already completed
  useEffect(() => {
    if (!blockchainData && ipfsProgress.status === 'idle' && blockchainProgress.status === 'idle') {
      handleStore()
    }
  }, []) // Run once on mount

  // Upload to IPFS with retries
  const uploadToIPFSWithRetry = async (retryAttempt = 0): Promise<string> => {
    try {
      setIpfsProgress({
        status: 'uploading',
        progress: 0,
        retryAttempt,
      })

      const result = await uploadToIPFS(fileData.file)

      setIpfsProgress({
        status: 'success',
        progress: 100,
        cid: result.cid,
      })

      return result.cid
    } catch (err: any) {
      const errorMessage = getIPFSErrorMessage(err)

      // Retry logic
      if (retryAttempt < UPLOAD_CONFIG.ipfs.maxRetries) {
        console.log(`IPFS upload failed, retrying (${retryAttempt + 1}/${UPLOAD_CONFIG.ipfs.maxRetries})...`)

        // Wait before retry
        await new Promise((resolve) => setTimeout(resolve, UPLOAD_CONFIG.ipfs.retryDelay))

        return uploadToIPFSWithRetry(retryAttempt + 1)
      }

      // Max retries reached
      setIpfsProgress({
        status: 'error',
        progress: 0,
        error: errorMessage,
        retryAttempt,
      })

      throw new Error(errorMessage)
    }
  }

  // Store on blockchain
  const storeOnBlockchain = async (ipfsCid: string): Promise<BlockchainData> => {
    try {
      // Gas estimation
      setBlockchainProgress({
        status: 'estimating',
      })

      // Estimate gas (simplified - in production you'd call estimateGas on the contract)
      const gasEstimate = BigInt(200000) // Rough estimate
      const gasEstimateETH = ethers.formatEther(gasEstimate)

      setBlockchainProgress({
        status: 'estimating',
        gasEstimate,
        gasEstimateETH,
      })

      // Send transaction
      setBlockchainProgress((prev) => ({
        ...prev,
        status: 'sending',
      }))

      const txHash = await storeDocumentHash(
        fileData.hash,
        signatureData.timestamp,
        signatureData.signature,
        signatureData.signerAddress,
        ipfsCid
      )

      if (!txHash) {
        throw new Error('Transaction failed - no transaction hash returned')
      }

      setBlockchainProgress((prev) => ({
        ...prev,
        status: 'confirming',
        txHash,
        confirmations: 0,
      }))

      // Wait for confirmations (simplified - in production you'd use provider.waitForTransaction)
      // For now, we'll simulate waiting
      await new Promise((resolve) => setTimeout(resolve, 3000))

      setBlockchainProgress((prev) => ({
        ...prev,
        status: 'confirmed',
        confirmations: UPLOAD_CONFIG.blockchain.minConfirmations,
      }))

      // Create blockchain data
      const blockchainData: BlockchainData = {
        txHash,
        blockNumber: 0, // Would get from transaction receipt
        confirmations: UPLOAD_CONFIG.blockchain.minConfirmations,
        ipfsCID: ipfsCid,
        gasUsed: gasEstimate,
        timestamp: new Date(),
        explorerUrl: networkConfig.explorerUrl
          ? `${networkConfig.explorerUrl}/tx/${txHash}`
          : '',
      }

      return blockchainData
    } catch (err: any) {
      console.error('Blockchain storage error:', err)

      setBlockchainProgress({
        status: 'error',
        error: err.message || 'Failed to store on blockchain',
      })

      throw err
    }
  }

  // Main storage handler
  const handleStore = async () => {
    try {
      setError(null)

      // Step 1: Upload to IPFS
      const ipfsCid = await uploadToIPFSWithRetry()

      // Step 2: Store on blockchain
      const data = await storeOnBlockchain(ipfsCid)

      // Success
      onStored(data)
    } catch (err: any) {
      console.error('Storage error:', err)
      setError(err.message || 'Failed to complete storage process')
    }
  }

  // Retry IPFS upload
  const retryIPFSUpload = async () => {
    setIpfsProgress({ status: 'idle', progress: 0 })
    setBlockchainProgress({ status: 'idle' })
    setError(null)
    await handleStore()
  }

  // Retry blockchain transaction
  const retryBlockchainTx = async () => {
    if (ipfsProgress.cid) {
      setBlockchainProgress({ status: 'idle' })
      setError(null)
      try {
        const data = await storeOnBlockchain(ipfsProgress.cid)
        onStored(data)
      } catch (err: any) {
        setError(err.message || 'Failed to retry blockchain transaction')
      }
    }
  }

  return (
    <div className="space-y-6">
      {/* Summary */}
      <div className="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4">
          Storage Summary
        </h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Document</p>
            <p className="text-gray-900 dark:text-white font-mono text-sm">{fileData.name}</p>
          </div>
          <div>
            <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Hash</p>
            <code className="text-xs font-mono text-gray-900 dark:text-white">
              {HashUtils.formatHash(fileData.hash, 8)}
            </code>
          </div>
          <div>
            <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Signer</p>
            <AddressDisplay address={signatureData.signerAddress} showCopy={false} showLink={false} />
          </div>
          <div>
            <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Network</p>
            <p className="text-gray-900 dark:text-white">{networkConfig.name}</p>
          </div>
        </div>
      </div>

      {/* Error Display */}
      {error && (
        <div className="bg-red-50 dark:bg-red-900/20 rounded-lg p-4 border border-red-200 dark:border-red-800">
          <div className="flex items-start space-x-3">
            <AlertCircle className="w-5 h-5 text-red-600 dark:text-red-400 flex-shrink-0 mt-0.5" />
            <div className="flex-1">
              <p className="text-red-800 dark:text-red-200 font-medium">Storage Failed</p>
              <p className="text-red-700 dark:text-red-300 text-sm mt-1">{error}</p>
            </div>
          </div>
        </div>
      )}

      {/* IPFS Upload Progress */}
      <div className="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
        <div className="flex items-start space-x-4">
          <div className="flex-shrink-0">
            {ipfsProgress.status === 'uploading' && (
              <Loader2 className="w-6 h-6 animate-spin text-blue-600 dark:text-blue-400" />
            )}
            {ipfsProgress.status === 'success' && (
              <CheckCircle className="w-6 h-6 text-green-600 dark:text-green-400" />
            )}
            {ipfsProgress.status === 'error' && (
              <AlertCircle className="w-6 h-6 text-red-600 dark:text-red-400" />
            )}
            {ipfsProgress.status === 'idle' && (
              <Cloud className="w-6 h-6 text-gray-400 dark:text-gray-600" />
            )}
          </div>

          <div className="flex-1">
            <h4 className="font-semibold text-gray-900 dark:text-white mb-2">
              Step 1: Upload to IPFS
            </h4>

            {ipfsProgress.status === 'uploading' && (
              <div className="space-y-2">
                <p className="text-sm text-gray-600 dark:text-gray-400">
                  Uploading file to IPFS...
                  {ipfsProgress.retryAttempt ? ` (Retry ${ipfsProgress.retryAttempt}/${UPLOAD_CONFIG.ipfs.maxRetries})` : ''}
                </p>
                <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div
                    className="bg-blue-600 h-2 rounded-full transition-all duration-300 animate-pulse"
                    style={{ width: '60%' }}
                  />
                </div>
              </div>
            )}

            {ipfsProgress.status === 'success' && ipfsProgress.cid && (
              <div className="space-y-2">
                <p className="text-sm text-green-600 dark:text-green-400 font-medium">
                  Successfully uploaded to IPFS
                </p>
                <div className="bg-green-50 dark:bg-green-900/20 rounded p-3">
                  <p className="text-xs font-medium text-green-700 dark:text-green-300 mb-1">
                    IPFS CID:
                  </p>
                  <code className="text-xs font-mono text-green-800 dark:text-green-200 break-all">
                    {ipfsProgress.cid}
                  </code>
                  <a
                    href={getIPFSGatewayURL(ipfsProgress.cid)}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center space-x-1 text-xs text-green-600 dark:text-green-400 hover:underline mt-2"
                  >
                    <span>View on IPFS Gateway</span>
                    <ExternalLink className="w-3 h-3" />
                  </a>
                </div>
              </div>
            )}

            {ipfsProgress.status === 'error' && (
              <div className="space-y-2">
                <p className="text-sm text-red-600 dark:text-red-400">{ipfsProgress.error}</p>
                <button
                  onClick={retryIPFSUpload}
                  className="flex items-center space-x-2 px-3 py-2 text-sm bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300 rounded hover:bg-red-200 dark:hover:bg-red-900/30 transition-colors"
                >
                  <RefreshCw className="w-4 h-4" />
                  <span>Retry Upload</span>
                </button>
              </div>
            )}

            {ipfsProgress.status === 'idle' && (
              <p className="text-sm text-gray-600 dark:text-gray-400">Waiting to start...</p>
            )}
          </div>
        </div>
      </div>

      {/* Blockchain Transaction Progress */}
      <div className="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
        <div className="flex items-start space-x-4">
          <div className="flex-shrink-0">
            {(blockchainProgress.status === 'estimating' ||
              blockchainProgress.status === 'sending' ||
              blockchainProgress.status === 'confirming') && (
              <Loader2 className="w-6 h-6 animate-spin text-indigo-600 dark:text-indigo-400" />
            )}
            {blockchainProgress.status === 'confirmed' && (
              <CheckCircle className="w-6 h-6 text-green-600 dark:text-green-400" />
            )}
            {blockchainProgress.status === 'error' && (
              <AlertCircle className="w-6 h-6 text-red-600 dark:text-red-400" />
            )}
            {blockchainProgress.status === 'idle' && (
              <Shield className="w-6 h-6 text-gray-400 dark:text-gray-600" />
            )}
          </div>

          <div className="flex-1">
            <h4 className="font-semibold text-gray-900 dark:text-white mb-2">
              Step 2: Store on Blockchain
            </h4>

            {blockchainProgress.status === 'estimating' && (
              <div className="space-y-2">
                <p className="text-sm text-gray-600 dark:text-gray-400">Estimating gas fees...</p>
                {blockchainProgress.gasEstimateETH && (
                  <p className="text-xs text-gray-500 dark:text-gray-500">
                    Estimated gas: {blockchainProgress.gasEstimateETH} ETH
                  </p>
                )}
              </div>
            )}

            {blockchainProgress.status === 'sending' && (
              <p className="text-sm text-indigo-600 dark:text-indigo-400">
                Sending transaction to blockchain...
              </p>
            )}

            {blockchainProgress.status === 'confirming' && (
              <div className="space-y-2">
                <p className="text-sm text-indigo-600 dark:text-indigo-400">
                  Waiting for confirmations... ({blockchainProgress.confirmations || 0}/
                  {UPLOAD_CONFIG.blockchain.minConfirmations})
                </p>
                {blockchainProgress.txHash && (
                  <code className="text-xs font-mono text-gray-600 dark:text-gray-400 block">
                    {blockchainProgress.txHash}
                  </code>
                )}
              </div>
            )}

            {blockchainProgress.status === 'confirmed' && blockchainProgress.txHash && (
              <div className="space-y-2">
                <p className="text-sm text-green-600 dark:text-green-400 font-medium">
                  Transaction confirmed!
                </p>
                <div className="bg-green-50 dark:bg-green-900/20 rounded p-3">
                  <p className="text-xs font-medium text-green-700 dark:text-green-300 mb-1">
                    Transaction Hash:
                  </p>
                  <code className="text-xs font-mono text-green-800 dark:text-green-200 break-all">
                    {blockchainProgress.txHash}
                  </code>
                </div>
              </div>
            )}

            {blockchainProgress.status === 'error' && (
              <div className="space-y-2">
                <p className="text-sm text-red-600 dark:text-red-400">
                  {blockchainProgress.error}
                </p>
                {ipfsProgress.cid && (
                  <button
                    onClick={retryBlockchainTx}
                    className="flex items-center space-x-2 px-3 py-2 text-sm bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300 rounded hover:bg-red-200 dark:hover:bg-red-900/30 transition-colors"
                  >
                    <RefreshCw className="w-4 h-4" />
                    <span>Retry Transaction</span>
                  </button>
                )}
              </div>
            )}

            {blockchainProgress.status === 'idle' && (
              <p className="text-sm text-gray-600 dark:text-gray-400">
                {ipfsProgress.status === 'success' ? 'Ready to send...' : 'Waiting for IPFS upload...'}
              </p>
            )}
          </div>
        </div>
      </div>

      {/* Success State with Action Buttons */}
      {blockchainData && (
        <div className="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-lg p-6 border-2 border-green-200 dark:border-green-800">
          <div className="flex items-center space-x-3 mb-4">
            <CheckCircle className="w-8 h-8 text-green-600 dark:text-green-400" />
            <h3 className="text-xl font-bold text-green-800 dark:text-green-200">
              Document Stored Successfully!
            </h3>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div className="bg-white/50 dark:bg-gray-800/50 rounded p-3">
              <p className="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">IPFS CID</p>
              <a
                href={getIPFSGatewayURL(blockchainData.ipfsCID)}
                target="_blank"
                rel="noopener noreferrer"
                className="text-xs font-mono text-green-700 dark:text-green-300 hover:underline break-all flex items-center gap-1"
              >
                {blockchainData.ipfsCID}
                <ExternalLink className="w-3 h-3 flex-shrink-0" />
              </a>
            </div>
            <div className="bg-white/50 dark:bg-gray-800/50 rounded p-3">
              <p className="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">
                Transaction Hash
              </p>
              {blockchainData.explorerUrl ? (
                <a
                  href={blockchainData.explorerUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-xs font-mono text-green-700 dark:text-green-300 hover:underline break-all flex items-center gap-1"
                >
                  {HashUtils.formatHash(blockchainData.txHash, 10)}
                  <ExternalLink className="w-3 h-3 flex-shrink-0" />
                </a>
              ) : (
                <code className="text-xs font-mono text-green-700 dark:text-green-300 break-all">
                  {HashUtils.formatHash(blockchainData.txHash, 10)}
                </code>
              )}
            </div>
          </div>

          <div className="flex flex-col sm:flex-row gap-3">
            <button
              onClick={onSignAnother}
              className="flex-1 flex items-center justify-center space-x-2 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all font-medium"
            >
              <FileText className="w-5 h-5" />
              <span>Sign Another Document</span>
            </button>
            <button
              onClick={onViewHistory}
              className="flex-1 flex items-center justify-center space-x-2 px-6 py-3 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors font-medium"
            >
              <History className="w-5 h-5" />
              <span>View in History</span>
            </button>
          </div>
        </div>
      )}
    </div>
  )
}
